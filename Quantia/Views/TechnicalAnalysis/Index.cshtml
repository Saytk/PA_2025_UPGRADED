@{
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Section = "TechnicalAnalysis";
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Technical Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts" integrity="sha384-Hf0cGsweCbozkRP14s5KIue6STJYKaoipB/i1gTdbX+umKD59qA/Szk42FPMuKtB" crossorigin="anonymous"></script>
</head>
<body>
    <div class="dashboard-grid">

        <div class="">
            <h1>Technical Analysis</h1>

            <!-- 🔹 Section Candlestick -->
            <div class="card">
                <div style="margin-bottom: 20px;">
                    <label>
                        Symbol:
                        <select id="symbolSelect" style="width:30%">
                            <option value="BTCUSDT">BITCOIN</option>
                            <option value="ETHUSDT">ETHERUM</option>
                        </select>
                    </label>

                    <label>
                        Start Date:
                        <input type="datetime-local" id="startDate" value="2025-07-07T09:00" />
                    </label>

                    <label>
                        End Date:
                        <input type="datetime-local" id="endDate" value="2025-07-07T09:00" />
                    </label>

                    <button onclick="loadCandlestickData()">Load</button>
                </div>

                <h3>Candlestick Chart</h3>
                <div id="candlestick-chart" style="max-width: 1000px; margin: auto;"></div>
            </div>

        </div>
    </div>

    <script>
        let chart; // Pour candlestick

        async function loadCandlestickData() {
            const select = document.getElementById("symbolSelect");
            const symbolText = select.options[select.selectedIndex].text;
            const symbol = document.getElementById('symbolSelect').value;
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;

            const url = `/api/candlestick/load?symbol=${symbol}&start_date=${start}&end_date=${end}`;

            try {
                const res = await fetch(url);
                const json = await res.json();

                const transformed = json.data.map(d => ({
                    x: new Date(d.timestamp_utc).toISOString(),
                    y: [d.open, d.high, d.low, d.close]
                }));

                const options = {
                    chart: { type: 'candlestick', height: 400 },
                    title: { text: `${symbolText} Candlestick Chart`, align: 'left' },
                    xaxis: { type: 'datetime' },
                    yaxis: { tooltip: { enabled: true } },
                    plotOptions: {
                        candlestick: {
                            colors: {
                                upward: '#26a69a',
                                downward: '#ef5350'
                            }
                        }
                    },
                    series: [{ data: transformed }]
                };

                if (!chart) {
                    chart = new ApexCharts(document.querySelector("#candlestick-chart"), options);
                    chart.render();
                } else {
                    chart.updateOptions({ title: { text: `${symbol} Candlestick Chart` } });
                    chart.updateSeries([{ data: transformed }]);
                }

            } catch (error) {
                console.error('Error loading candlestick data:', error);
                alert("Failed to load candlestick data from API.");
            }
        }
        window.onload = () => {
            loadCandlestickData();
        };
    </script>
</body>
</html>
